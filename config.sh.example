#!/bin/bash
# config.sh.example - 環境變數設定範本
# 複製此檔案為 config.sh 並填入實際值

# ============================================================================
# 基本 AWS 設定
# ============================================================================
export SOURCE_REGION="ap-northeast-1"  # Tokyo Region
export TARGET_REGION="ap-east-2"       # Taipei Region
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

# ============================================================================
# 服務設定
# ============================================================================
export CLUSTER_NAME="your-cluster"           # EKS/ECS 叢集名稱
export DB_INSTANCE_ID="your-db-instance"     # RDS 資料庫識別符

# ============================================================================
# VPC 網路設定
# ============================================================================
export VPC_NAME="migration-vpc"              # 目標區域的 VPC 名稱
export VPC_CIDR="10.0.0.0/16"               # 如果需要建立新 VPC 時使用

# ============================================================================
# EC2 特定設定
# ============================================================================
export INSTANCE_ID="i-1234567890abcdef0"     # 要遷移的 EC2 執行個體 ID
export KEY_PAIR_NAME="my-key-pair"           # EC2 金鑰對名稱

# ============================================================================
# DNS 設定（選用）
# ============================================================================
export DOMAIN_NAME="your-domain.com"         # 您的域名
export HOSTED_ZONE_ID="Z1234567890ABC"       # Route 53 Hosted Zone ID

# ============================================================================
# 進階設定（選用）
# ============================================================================
export ECR_REPLICATION_ENABLED="true"        # 是否啟用 ECR 複製
export RDS_MIGRATION_ENABLED="true"          # 是否啟用 RDS 遷移
export DNS_SWITCHING_ENABLED="false"         # 是否啟用 DNS 切換（需要設定 HOSTED_ZONE_ID）

# ============================================================================
# 驗證函數
# ============================================================================
validate_config() {
    local errors=()
    local warnings=()
    
    # 必要參數檢查
    if [[ -z "$SOURCE_REGION" ]]; then
        errors+=("SOURCE_REGION 未設定")
    fi
    
    if [[ -z "$TARGET_REGION" ]]; then
        errors+=("TARGET_REGION 未設定")
    fi
    
    if [[ -z "$AWS_ACCOUNT_ID" ]]; then
        errors+=("無法獲取 AWS_ACCOUNT_ID，請檢查 AWS CLI 設定")
    fi
    
    if [[ -z "$CLUSTER_NAME" ]]; then
        errors+=("CLUSTER_NAME 未設定")
    fi
    
    if [[ -z "$VPC_NAME" ]]; then
        errors+=("VPC_NAME 未設定")
    fi
    
    # 選用參數檢查
    if [[ -z "$DB_INSTANCE_ID" ]]; then
        warnings+=("DB_INSTANCE_ID 未設定，將跳過 RDS 遷移")
    fi
    
    if [[ -z "$INSTANCE_ID" ]]; then
        warnings+=("INSTANCE_ID 未設定，EC2 遷移需要此參數")
    fi
    
    if [[ -z "$KEY_PAIR_NAME" ]]; then
        warnings+=("KEY_PAIR_NAME 未設定，EC2 遷移需要此參數")
    fi
    
    if [[ -z "$HOSTED_ZONE_ID" ]]; then
        warnings+=("HOSTED_ZONE_ID 未設定，將跳過 DNS 流量切換")
    fi
    
    # 顯示錯誤
    if [[ ${#errors[@]} -gt 0 ]]; then
        echo "❌ 設定錯誤："
        printf '  - %s\n' "${errors[@]}"
        exit 1
    fi
    
    # 顯示警告
    if [[ ${#warnings[@]} -gt 0 ]]; then
        echo "⚠️  設定警告："
        printf '  - %s\n' "${warnings[@]}"
        echo ""
    fi
    
    echo "✅ 設定驗證通過"
    echo "來源區域: $SOURCE_REGION"
    echo "目標區域: $TARGET_REGION"
    echo "AWS 帳號: $AWS_ACCOUNT_ID"
    echo "叢集名稱: $CLUSTER_NAME"
    echo "VPC 名稱: $VPC_NAME"
}

# 顯示設定摘要
show_config_summary() {
    echo "==================== 設定摘要 ===================="
    echo "來源區域: $SOURCE_REGION"
    echo "目標區域: $TARGET_REGION"
    echo "AWS 帳號: $AWS_ACCOUNT_ID"
    echo "叢集名稱: $CLUSTER_NAME"
    echo "VPC 名稱: $VPC_NAME"
    echo "VPC CIDR: $VPC_CIDR"
    
    if [[ -n "$DB_INSTANCE_ID" ]]; then
        echo "資料庫 ID: $DB_INSTANCE_ID"
    fi
    
    if [[ -n "$INSTANCE_ID" ]]; then
        echo "EC2 執行個體 ID: $INSTANCE_ID"
    fi
    
    if [[ -n "$KEY_PAIR_NAME" ]]; then
        echo "金鑰對名稱: $KEY_PAIR_NAME"
    fi
    
    if [[ -n "$DOMAIN_NAME" ]]; then
        echo "域名: $DOMAIN_NAME"
    fi
    
    if [[ -n "$HOSTED_ZONE_ID" ]]; then
        echo "Hosted Zone ID: $HOSTED_ZONE_ID"
    fi
    
    echo "=================================================="
}

# 如果直接執行此腳本，執行驗證
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    validate_config
    show_config_summary
fi
